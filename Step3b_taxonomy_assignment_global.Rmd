---
title: "Step 3b - assign taxonomy w/ global db"
author: "B.Littleford-Colquhoun & T.Divoll"
date: "2023-09-21"
html_document:
  df_print: paged
  toc: true
params:
  todaydate = r'Sys.date()'
  user =
  project_code = 
  seq_dates = []
  output_path = 
---
This notebook can be used to run the OBITools 1.2.12 pipeline and serve as a tutorial. Run through each code chunk and inspect the outputs.

```{r include=FALSE}
## Only needed for knitr to render this notebook
if (!require("pacman")) install.packages("pacman")
pacman::p_load(knitr, here, tidyr, dplyr, readxl, stringr, spgs, filesstrings)
here::i_am("./Step3b_taxonomy_assignment.Rmd")
```

#### Set up standard path variables
Here, you want to enter the folder name that you created during Step2

```{r}
DATETIME <-params$datetime
DATE<- str_extract(DATETIME, "[^_]+") #edit DATETIME to match the analysis folder name that was created when running step2, if not still saved in your R environment
FILE_NAME<-sprintf("%s_alluniq.clean.fasta", DATE) #edit the YYYYMMDD to match the date of the file you created at the end of step2 in the "merged_path" directory.

cleaned_obitools_fasta<-file.path(here("all_results", FILE_NAME)) #should not need to edit this code as it pulls the date and file name you set in the previous 2 lines of code

global_ref_db<-file.path("/oscar/data/tkartzin/global_ref_lib_plants/YYYYMMDD/YYYYMMDD_ecoPCRformat") #-d in ecotag; ecoPCR taxonomy Database name. Need to edit YYYYMMDD and name of taxonomy database to match that of the most recent global reference library you want to use.

ref_seq<-file.path("/oscar/data/tkartzin/global_ref_lib_plants/YYYYMMDD/db_YYYYMMDD_P6set.fasta") #-R in ecotag; fasta file containing the reference sequences. Need to edit YYYYMMDD and name of fasta file to match that of the most recent global reference library you want to use. 
```

```{r}
## make environment variables that can be passed to bash code chunks
Sys.setenv(cleaned_obitools_fasta=cleaned_obitools_fasta)
Sys.setenv(global_ref_db=global_ref_db)
Sys.setenv(ref_seq=ref_seq)
Sys.setenv(DATE=DATE)
```

#### Assign taxonomy to each sequence using the global reference library
```{bash}
source ~/.bash_profile
conda activate /users/${user}/.conda/envs/obitools-env
cd $output_path

ecotag -d ${global_ref_db} -R ${ref_seq} ${cleaned_obitools_fasta} > ${DATE}_alluniq.clean.tag.fasta

#Count number of sequences in your file
obicount ${DATE}_alluniq.clean.tag.fasta --without-progress-bar
```

Un-useful attributes can be removed from sequences
```{bash}
source ~/.bash_profile
conda activate /users/${user}/.conda/envs/obitools-env
cd $output_path

obiannotate --delete-tag=scientific_name_by_db --delete-tag=obiclean_samplecount \
  --delete-tag=obiclean_count --delete-tag=obiclean_singletoncount \
  --delete-tag=obiclean_cluster --delete-tag=obiclean_internalcount \
  --delete-tag=obiclean_head --delete-tag=taxid_by_db --delete-tag=obiclean_headcount \
  --delete-tag=id_status --delete-tag=rank_by_db --delete-tag=order_name \
  --delete-tag=order ${output_path}/${DATE}_alluniq.clean.tag.fasta > \
  ${output_path}/${DATE}_alluniq.clean.tag.ann.fasta

#count number of sequences in file (should match above)
obicount -a ${DATE}_alluniq.clean.tag.ann.fasta --without-progress-bar
```

### Create output for use in phyloseq
This is your final OBITools output (resembles a large ASV/OTU table) that can be used to create a phyloseq object in the next step
```{bash}
source ~/.bash_profile
conda activate /users/${user}/.conda/envs/obitools-env
cd $output_path

obitab -o ${DATE}_alluniq.clean.tag.ann.fasta > ${DATE}_alluniq.clean.tag.ann.tab
```